- name: Install Prometheus and Grafana on AKS
  hosts: localhost
  connection: local
  vars:
    prometheus_namespace: monitoring
    grafana_namespace: monitoring
  tasks:
    - name: Install Helm using Homebrew
      community.general.homebrew:
        name: helm
        state: present
      when: ansible_os_family == "Darwin"

    - name: Create monitoring namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ prometheus_namespace }}"
        state: present

    - name: Add Prometheus Helm repo
      kubernetes.core.helm_repository:
        name: prometheus-community
        repo_url: https://prometheus-community.github.io/helm-charts

    - name: Install Prometheus via Helm
      kubernetes.core.helm:
        name: prometheus
        chart_ref: prometheus-community/prometheus
        release_namespace: "{{ prometheus_namespace }}"
        state: present
        values:
          server:
            service:
              type: LoadBalancer
              port: 9090
              targetPort: 9090
            extraScrapeConfigs: |
              - job_name: 'azuredev-appservice'
                static_configs:
                  - targets: ['azuredev-appservice.dev.svc.cluster.local:8080']

    - name: Add Grafana Helm repo
      kubernetes.core.helm_repository:
        name: grafana
        repo_url: https://grafana.github.io/helm-charts

    - name: Install Grafana via Helm
      kubernetes.core.helm:
        name: grafana
        chart_ref: grafana/grafana
        release_namespace: "{{ grafana_namespace }}"
        state: present
        values:
          service:
            type: LoadBalancer
            port: 3000
          adminPassword: admin123