name: Build and Deploy to Azure

on:
  push:
    branches:
      - main # Web App
      - dev  # AKS with ArgoCD

permissions:
  contents: write
  id-token: write 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }} # Use branch name as environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Install dependencies for both Web App and AKS
      - name: Install dependencies
        run: npm install

      # AKS Deployment (dev branch)
      - name: Set NODE_ENV (AKS)
        if: github.ref == 'refs/heads/dev'
        run: echo "NODE_ENV=development" >> $GITHUB_ENV

      - name: Docker Login to ACR (AKS)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo ${{ secrets.ACR_PASSWORD }} | docker login ailidevacr.azurecr.io --username ${{ secrets.ACR_USERNAME }} --password-stdin

      - name: Build and push Docker image (AKS)
        if: github.ref == 'refs/heads/dev'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ailidevacr.azurecr.io/azuredev-appservice:${{ github.sha }}
          build-args: NODE_ENV=development

      - name: Install kubectl
        if: github.ref == 'refs/heads/dev'
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to AKS
        if: github.ref == 'refs/heads/dev'
        run: |
          az aks get-credentials --resource-group Aili --name AiliDevAKS --admin

          - name: Sync ArgoCD Application (AKS)
          if: github.ref == 'refs/heads/dev'
          run: |
            echo "ðŸ”„ Updating ArgoCD app-of-apps.yaml with image tag: ${{ github.sha }}"
        
            # Update image tag in ArgoCD manifest
            sed -i "s/tag: \".*\"/tag: \"${{ github.sha }}\"/g" argocd/app-of-apps.yaml
            sed -i "s|repoURL: https://github.com/\${{ github.repository }}.git|repoURL: https://github.com/${{ github.repository }}.git|g" argocd/app-of-apps.yaml
        
            git config --global user.email "github-actions@github.com"
            git config --global user.name "GitHub Actions"
            git add argocd/app-of-apps.yaml
            git commit -m "Update image tag to ${{ github.sha }} for ArgoCD deployment" || echo "â„¹ï¸ No changes to commit."
        
            echo "ðŸ“¤ Attempting to push updated ArgoCD file..."
            git push || echo "âš ï¸ Warning: Failed to push changes to GitHub. Proceeding anyway."
        
            echo "ðŸš€ Applying ArgoCD configuration..."
            kubectl apply -f argocd/app-of-apps.yaml        
      # Web App Deployment (main branch)
      - name: Set NODE_ENV (Web App)
        if: github.ref == 'refs/heads/main'
        run: echo "NODE_ENV=production" >> $GITHUB_ENV

      - name: Zip app content with node_modules (Web App)
        if: github.ref == 'refs/heads/main'
        run: |
          npm install # Ensure node_modules is present
          zip -r app.zip * .[^.]* -x "*.git*"

      - name: Deploy to Azure Web App (Web App)
        if: github.ref == 'refs/heads/main'
        uses: azure/webapps-deploy@v2
        with:
          app-name: AiliDevAppService
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: app.zip
        env:
          NODE_ENV: production